<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Now Playing - SoundStream</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        min-height: 100vh;
        overflow: hidden;
        background: #000;
        color: #fff;
      }

      .background-layer {
        position: fixed;
        inset: 0;
        background-size: cover;
        background-position: center bottom;
        opacity: 0;
        transition: opacity 1.5s ease-in-out;
        will-change: opacity;
      }

      .background-layer.active {
        opacity: 1;
      }

      .background-layer.blurred {
        filter: blur(40px) brightness(0.35);
        transform: scale(1.08);
      }

      .background-overlay {
        position: fixed;
        inset: 0;
        background: linear-gradient(
          180deg,
          rgba(0, 0, 0, 0.15) 0%,
          rgba(0, 0, 0, 0.55) 55%,
          rgba(0, 0, 0, 0.9) 100%
        );
        z-index: 2;
      }

      .bottom-bar {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 32px 60px 40px;
        display: flex;
        gap: 48px;
        align-items: flex-end;
        z-index: 10;
        opacity: 1;
        transition: opacity 0.3s ease;
      }

      .bottom-bar.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .artwork-container {
        width: 33vh;
        height: 33vh;
        max-width: 442px;
        flex-shrink: 0;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 30px 60px rgba(0, 0, 0, 0.8);
        background: rgba(0, 0, 0, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .artwork {
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0;
        transition: opacity 0.6s ease;
      }

      .artwork.loaded {
        opacity: 1;
      }

      .info {
        flex: 1;
        min-width: 0;
      }

      .title {
        font-size: 2.6rem;
        font-weight: 700;
        letter-spacing: -0.5px;
        margin-bottom: 6px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .artist-text {
        font-size: 1.3rem;
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 16px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .progress-row {
        display: flex;
        align-items: center;
        gap: 18px;
      }

      .time {
        width: 70px;
        font-variant-numeric: tabular-nums;
        color: rgba(255, 255, 255, 0.75);
        display: inline-flex;
        align-items: center;
        line-height: 1;
        min-height: 1em;
      }

      .time.duration {
        justify-content: flex-end;
        text-align: right;
      }

      .progress-container {
        flex: 1;
        height: 3px;
        display: flex;
        align-items: center;
        position: relative;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 3px;
        overflow: hidden;
      }

      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #ffffff, rgba(255, 255, 255, 0.9));
        border-radius: 3px;
        transition: width 1s linear;
        width: 0%;
      }

      .not-playing-container {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        opacity: 1;
        transition: opacity 0.3s ease;
      }

      .not-playing-container.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .not-playing {
        text-align: center;
      }

      .not-playing h2 {
        font-size: 2rem;
        margin-bottom: 12px;
      }

      .not-playing p {
        font-size: 1.2rem;
        color: rgba(255, 255, 255, 0.7);
      }

      @media (max-width: 1100px) {
        .bottom-bar {
          flex-direction: column;
          align-items: center;
        }

        .artwork-container {
          width: 55vw;
          height: 55vw;
        }

        .info {
          width: 100%;
        }

        .title {
          font-size: 2rem;
          text-align: center;
        }

        .artist-text {
          text-align: center;
        }

        .progress-row {
          flex-direction: column;
          gap: 10px;
        }

        .progress-container {
          width: 100%;
        }

        .time {
          width: auto;
        }
      }
    </style>
  </head>
  <body>
    <div id="bg-layer-0" class="background-layer active"></div>
    <div id="bg-layer-1" class="background-layer"></div>
    <div class="background-overlay"></div>

    <div class="not-playing-container">
      <div class="not-playing">
        <h2>Connecting to LMS...</h2>
        <p>Please wait</p>
      </div>
    </div>

    <div class="bottom-bar hidden">
      <div class="artwork-container">
        <img id="album-art" class="artwork" alt="Album art" />
      </div>
      <div class="info">
        <h1 class="title"></h1>
        <p class="artist-text"></p>
        <div class="progress-row">
          <span class="time current">0:00</span>
          <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
          </div>
          <span class="time duration">0:00</span>
        </div>
      </div>
    </div>

    <script>
      // Get URL parameters
      const params = new URLSearchParams(window.location.search);
      let host = params.get('host') || '';
      let port = params.get('port') || '9000';
      let playerId = params.get('player') || '';
      
      if (window.EMBEDDED_PARAMS) {
        host = window.EMBEDDED_PARAMS.host || host;
        port = window.EMBEDDED_PARAMS.port || port;
        playerId = window.EMBEDDED_PARAMS.player || playerId;
      }
      
      if (!host) host = '192.168.0.19';
      if (!port) port = '9000';
      
      const proxyUrl = '/api/lms/proxy';
      const AUDIODB_API_KEY = '2';
      const BACKGROUND_ROTATION_MS = 20000;

      // DOM Elements
      const bgLayers = [
        document.getElementById('bg-layer-0'),
        document.getElementById('bg-layer-1')
      ];
      const titleEl = document.querySelector('.title');
      const artistEl = document.querySelector('.artist-text');
      const currentTimeEl = document.querySelector('.time.current');
      const durationEl = document.querySelector('.time.duration');
      const progressBar = document.getElementById('progress-bar');
      const albumArt = document.getElementById('album-art');
      const bottomBar = document.querySelector('.bottom-bar');
      const notPlayingContainer = document.querySelector('.not-playing-container');

      // State
      let lastTrackId = '';
      let currentArtist = '';
      let artistImages = [];
      let currentImageIndex = 0;
      let activeBackgroundLayer = 0;
      let rotationTimer = null;
      let pollTimer = null;

      async function lmsRequest(pid, command) {
        const response = await fetch(proxyUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            host: host,
            port: parseInt(port) || 9000,
            playerId: pid,
            command: command
          })
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        return data.result || data;
      }

      async function getPlayers() {
        try {
          const result = await lmsRequest('', ['players', '0', '100']);
          return result.players_loop || [];
        } catch (e) {
          console.error('Failed to get players:', e);
          return [];
        }
      }

      async function getPlayerStatus(pid) {
        try {
          const result = await lmsRequest(pid, ['status', '-', '1', 'tags:aAlcdegiIKloNrstuwy']);
          return result;
        } catch (e) {
          console.error('Failed to get player status:', e);
          return null;
        }
      }

      async function fetchArtistImages(artistName) {
        if (!artistName || artistName === currentArtist) return;
        
        currentArtist = artistName;
        artistImages = [];
        currentImageIndex = 0;
        
        try {
          const response = await fetch(`https://www.theaudiodb.com/api/v1/json/${AUDIODB_API_KEY}/search.php?s=${encodeURIComponent(artistName)}`);
          const data = await response.json();
          
          if (data.artists && data.artists.length > 0) {
            const artist = data.artists[0];
            const images = [];
            
            if (artist.strArtistFanart) images.push(artist.strArtistFanart);
            if (artist.strArtistFanart2) images.push(artist.strArtistFanart2);
            if (artist.strArtistFanart3) images.push(artist.strArtistFanart3);
            if (artist.strArtistFanart4) images.push(artist.strArtistFanart4);
            if (artist.strArtistThumb) images.push(artist.strArtistThumb);
            if (artist.strArtistWideThumb) images.push(artist.strArtistWideThumb);
            
            artistImages = images.filter(url => url && url.length > 0);
            console.log(`Found ${artistImages.length} images for ${artistName}`);
            
            if (artistImages.length > 0) {
              startBackgroundRotation();
            }
          }
        } catch (e) {
          console.error('Failed to fetch artist images:', e);
        }
      }

      function setBackground(url, blurred = false) {
        const target = bgLayers[activeBackgroundLayer === 0 ? 1 : 0];
        const other = bgLayers[activeBackgroundLayer];
        const img = new Image();
        
        img.onload = () => {
          target.style.backgroundImage = `url('${url}')`;
          if (blurred) {
            target.classList.add('blurred');
          } else {
            target.classList.remove('blurred');
          }
          other.classList.remove('active');
          target.classList.add('active');
          activeBackgroundLayer = activeBackgroundLayer === 0 ? 1 : 0;
        };
        
        img.src = url;
      }

      function startBackgroundRotation() {
        if (rotationTimer) {
          clearInterval(rotationTimer);
        }
        
        if (artistImages.length === 0) return;
        
        const rotate = () => {
          const nextIndex = currentImageIndex % artistImages.length;
          setBackground(artistImages[nextIndex], false);
          currentImageIndex = (currentImageIndex + 1) % artistImages.length;
        };
        
        rotate(); // Show first image immediately
        
        if (artistImages.length > 1) {
          rotationTimer = setInterval(rotate, BACKGROUND_ROTATION_MS);
        }
      }

      function setAlbumArt(imageUrl) {
        if (imageUrl) {
          const img = new Image();
          img.onload = () => {
            albumArt.src = imageUrl;
            albumArt.classList.add('loaded');
          };
          img.src = imageUrl;
        } else {
          albumArt.classList.remove('loaded');
          albumArt.removeAttribute('src');
        }
      }

      function updateProgress(progress) {
        progressBar.style.width = `${Math.min(100, Math.max(0, progress))}%`;
      }

      function formatTime(seconds) {
        const safe = Math.max(0, Math.floor(seconds || 0));
        const mins = Math.floor(safe / 60).toString().padStart(1, '0');
        const secs = Math.floor(safe % 60).toString().padStart(2, '0');
        return `${mins}:${secs}`;
      }

      function updateDisplay(status) {
        const isPlaying = status.mode === 'play' || status.mode === 'pause';
        
        if (!isPlaying || !status.playlist_loop || status.playlist_loop.length === 0) {
          notPlayingContainer.classList.remove('hidden');
          bottomBar.classList.add('hidden');
          return;
        }
        
        notPlayingContainer.classList.add('hidden');
        bottomBar.classList.remove('hidden');
        
        const track = status.playlist_loop[0];
        const trackId = track.id || track.title;
        const trackTitle = track.title || 'Unknown';
        const artistName = track.artist || 'Unknown Artist';
        const duration = parseFloat(track.duration) || 0;
        const time = parseFloat(status.time) || 0;
        const progress = duration > 0 ? (time / duration) * 100 : 0;
        
        titleEl.textContent = trackTitle;
        artistEl.textContent = artistName;
        currentTimeEl.textContent = formatTime(time);
        durationEl.textContent = formatTime(duration);
        updateProgress(progress);
        
        // Update artwork and background on track change
        if (trackId !== lastTrackId) {
          lastTrackId = trackId;
          
          const artworkUrl = track.artwork_url 
            ? `/api/lms/image-proxy?url=${encodeURIComponent(track.artwork_url)}`
            : null;
          
          setAlbumArt(artworkUrl);
          
          // Fetch artist images
          if (artistName && artistName !== 'Unknown Artist') {
            fetchArtistImages(artistName);
          }
          
          // Set album art as fallback background
          if (artworkUrl) {
            setBackground(artworkUrl, true);
          }
        }
      }

      async function poll() {
        try {
          let pid = playerId;
          
          if (!pid) {
            const players = await getPlayers();
            if (players.length > 0) {
              pid = players[0].playerid;
              playerId = pid;
            }
          }
          
          if (pid) {
            const status = await getPlayerStatus(pid);
            if (status) {
              updateDisplay(status);
            }
          }
        } catch (e) {
          console.error('Poll error:', e);
        }
      }

      // Start polling
      poll();
      pollTimer = setInterval(poll, 2000);
    </script>
  </body>
</html>

